<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />

    <link rel="stylesheet" href="../public/css/nav.css">
    <link rel="stylesheet" href="../public/css/map.css">

    <link rel="icon" href="/public/favicon.ico" />
    <title>지도</title>
  </head>
  <body style="overflow: hidden;">

    <%- include('nav.html') %>

    <div id="map"></div>
    <div class="myloc" onclick="getCurrentPosBtn()">내 위치</div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1112b85e60dc2bf67fb4c01fcd044531"></script>
    <script defer>

      var mapContainer = document.getElementById('map'), // 지도를 표시할 div
          mapOption = {
            center: new kakao.maps.LatLng(37.495307, 127.028587), // 지도의 중심좌표
            level:4, // 지도의 확대 레벨
            mapTypeId : kakao.maps.MapTypeId.ROADMAP // 지도종류
          };

      // 지도를 생성한다
      var map = new kakao.maps.Map(mapContainer, mapOption);

      var lat;
      var lng;
      var options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      }
      function success(position) {
        console.log(position)

        lat = position.coords.latitude,
        lng = position.coords.longitude

        var locPosition = new kakao.maps.LatLng(lat, lng),
        message = '<div style="padding:5px;">여기에!?</div>'

        displayMarker(locPosition, message)
      }

      function error(err) {
        console.log(err)
      }

      if (navigator.geolocation) {
        alert('내 위치')
        var na = navigator.geolocation.watchPosition(success, error, options)
        console.log(na)
      }

      var mark
      var flag = false
      function displayMarker(locPosition, message) {
        if (flag) {
          mark.setMap(null)
        }
        mark = new kakao.maps.Marker({
          position: locPosition
        })
        mark.setMap(map)
        flag = true
        
        map.setCenter(locPosition)
      }

      var positions = [
        {
          title: '<%=store[0].name%>', 
          //latlng: new kakao.maps.LatLng(37.494655, 127.027749) 
          latlng: new kakao.maps.LatLng('<%=store[0].lat%>', '<%=store[0].lng%>')
        },
        {
          title: '<%=store[1].name%>', 
          latlng: new kakao.maps.LatLng('<%=store[1].lat%>', '<%=store[1].lng%>')
        },
        {
          title: '<%=store[2].name%>', 
          //latlng: new kakao.maps.LatLng(37.496214, 127.028793)
          latlng: new kakao.maps.LatLng('<%=store[2].lat%>', '<%=store[2].lng%>')
        }
      ];
      

      for(let i=0; i < positions.length; i++){
        var data = positions[i];
        displayMarker(data);
      }

      var clickedOverlay = null

      // 지도에 마커를 표시하는 함수입니다    
      function displayMarker(data) { 
        var marker = new kakao.maps.Marker({
          map: map,
          position: data.latlng
        });
        var overlay = new kakao.maps.CustomOverlay({
          yAnchor: 3,
          position: marker.getPosition()
        });
    
        var content = document.createElement('div');
        content.innerHTML =  data.title;
        content.style.cssText = 'background: white; border: 1px solid black';
      
        var closeBtn = document.createElement('button');
        closeBtn.innerHTML = '닫기';
        closeBtn.onclick = function () {
          overlay.setMap(null);
        };
        content.appendChild(closeBtn);

        // 마커를 클릭했을 때 커스텀 오버레이를 표시하고 이전 오버레이 닫음
        kakao.maps.event.addListener(marker, 'click', function() {
          if (clickedOverlay) {
            clickedOverlay.setMap(null)
          }
          overlay.setMap(map);
          clickedOverlay = overlay
        });

        // 지도 클릭 시 오버레이 닫음
        kakao.maps.event.addListener(map, 'click', function() {
          clickedOverlay.setMap(null)
        });

        overlay.setContent(content);
      }
   
      
      var flag = false
      function locationLoadSuccess(pos){
        // 현재 위치 받아오기
        var currentPos = new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);

        // 지도 이동(기존 위치와 가깝다면 부드럽게 이동)
        map.panTo(currentPos);

        if (flag) {
          marker.setMap(null);
        }

        // 마커 생성
        var marker = new kakao.maps.Marker({
          map: map,
          position: currentPos
        });

        // 기존에 마커가 있다면 제거
        marker.setMap(map);
        flag = true
      };

      function locationLoadError(pos){
        alert('위치 정보를 가져오는데 실패했습니다.');
      };

      // 위치 가져오기 버튼 클릭시
      function getCurrentPosBtn(){
        navigator.geolocation.getCurrentPosition(locationLoadSuccess,locationLoadError);
      }; 
    </script>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    -->
  </body>
</html>